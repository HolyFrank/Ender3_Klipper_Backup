#====================================================================
# Pressure Advance - Ellis Pattern
#====================================================================

[gcode_macro ELLIS_PRESSURE_ADVANCE_PATTERN]
gcode:
    {% set nozzle_diameter = params.NOZZLE_DIAMETER|default(0.4)|float %}
    {% set extrusion_multiplier = params.EXTRUSION_MULTIPLIER|default(1.0)|float %}
    {% set travel_speed = params.TRAVEL_SPEED|default(175)|int %}
    {% set retract_distance = params.RETRACT_DISTANCE|default(0.65)|float %}
    {% set retract_speed = params.RETRACT_SPEED|default(8)|int %}
    {% set unretract_speed = params.UNRETRACT_SPEED|default(10)|int %}
    {% set first_layer_height = params.FIRST_LAYER_HEIGHT|default(0.25)|float %}
    {% set first_layer_speed = params.FIRST_LAYER_SPEED|default(30)|int %}
    {% set first_layer_fan_speed = params.FIRST_LAYER_FAN_SPEED|default(0)|int %}
    {% set line_width = params.LINE_WIDTH|default(112.5)|float %}
    {% set print_speed = params.PRINT_SPEED|default(100)|int %}
    {% set fan_speed = params.FAN_SPEED|default(100)|int %}
    {% set acceleration = params.ACCELERATION|default(1600)|int %}
    {% set layer_count = params.LAYER_COUNT|default(4)|int %}
    {% set start_pa = params.PA_START_VALUE|default(0)|float %}
    {% set end_pa = params.PA_END_VALUE|default(0.08)|float %}
    {% set pa_increment = params.PA_INCREMENT|default(0.005)|float %}

    {% set nozzle_temp = params.NOZZLE_TEMP|default(215)|int %}
    {% set bed_temp = params.BED_TEMP|default(60)|int %}
    {% set line_spacing = 5 %}
    {% set num_lines = ((end_pa - start_pa) / pa_increment)|int + 1 %}
    {% set line_length = 100 %}

    M104 S{nozzle_temp} ; Régler la température de la buse
    M140 S{bed_temp} ; Régler la température du lit

    _CG28 ; Home conditionnel

    BED_MESH_CALIBRATE ; Calibration du maillage du lit

    M109 S{nozzle_temp} ; Attendre que la buse atteigne la température
    M190 S{bed_temp} ; Attendre que le lit atteigne la température

    SMART_PARK ; Utiliser le stationnement intelligent de KAMP
    M83 ; Mode d'extrusion relative
    G90 ; Positionnement absolu
    M204 S{acceleration} ; Régler l'accélération
    M106 S{(first_layer_fan_speed / 100.0 * 255)|int} ; Régler la vitesse du ventilateur pour la première couche

    LINE_PURGE ; Utiliser la purge en ligne de KAMP

    ; Imprimer l'échelle de valeurs PA
    G1 X10 Y5 Z{first_layer_height} F{travel_speed * 60}
    G1 E{retract_distance} F{unretract_speed * 60} ; Dé-rétracter
    G1 X160 Y5 E{150 * line_width / 100 * first_layer_height * extrusion_multiplier / (3.14159 * (nozzle_diameter/2)**2)} F{first_layer_speed * 60}
    G1 E-{retract_distance} F{retract_speed * 60} ; Rétracter

    {% for i in range(num_lines) %}
        {% set current_pa = start_pa + pa_increment * i %}
        SET_PRESSURE_ADVANCE ADVANCE={current_pa}

        {% for layer in range(layer_count) %}
            G1 X{10 + i * line_spacing} Y10 Z{first_layer_height + layer * 0.2} F{travel_speed * 60} ; Déplacer à la position de départ
            G1 E{retract_distance} F{unretract_speed * 60} ; Dé-rétracter
            
            G1 X{10 + i * line_spacing + line_length} Y{10 + line_length} E{line_length * line_width / 100 * 0.2 * extrusion_multiplier / (3.14159 * (nozzle_diameter/2)**2)} F{print_speed * 60} ; Ligne diagonale
            
            G1 E-{retract_distance} F{retract_speed * 60} ; Rétracter
            G1 Z{first_layer_height + layer * 0.2 + 0.5} F{travel_speed * 60} ; Saut en Z
        {% endfor %}

        {% if loop.first %}
            M106 S{(fan_speed / 100.0 * 255)|int} ; Régler la vitesse du ventilateur pour les couches suivantes après la première ligne
        {% endif %}
    {% endfor %}

    SET_PRESSURE_ADVANCE ADVANCE=0 ; Réinitialiser PA
    SMART_PARK ; Utiliser le stationnement intelligent de KAMP à la fin